# State Transfers
       
클러스터에서 노드로 데이터를 복제하여 **클러스터와 노드를 동기화하는 프로세스를 프로비저닝이라고 한다.**            
Galera Cluster에서 프로비저닝에 사용하는 방법 2가지가 있다.         
* **증분 상태 전송(IST) :** 누락된 트랜잭션만 전송한다.          
* **상태 스냅샷 전송(SST) :** 전체 노드 상태의 스냅샷을 전송한다.       
 
노드가 추가 될 때  Galera Cluster는 기존에 데이터들을 상태를 복제하여 참여하는 노드에 전송한다.   
스냅샷을 전송하는 노드를 Donor, 스냅샷을 전달받아 새로이 참여하는 노드를 Joiner라고 부른다.   
즉, **상태 전송시에는 노드 중에 Donor로 되어있는 설정된 노드의 데이터를 복제하여 전송한다.**  

## 증분 상태 전송(IST)
  
IST 는 복제간에 누락된 트랜잭션을 찾아서 프로비저닝하는 방식이다.      
SST 방식 보다는 빠르지만, 특정 조건을 만족해야하만 사용할 수 있다.      
     
* 복제를 받을 노드의 State UUID는 그룹의 State UUID가 같아야 한다.   
* 누락된 모든 Write-Set 들은 도너 Write-Set-Cache 에서 얻을 수 있어야한다.    
       
조건이 충족되면 Donor 노드는 누락된 트랜잭션만 전송하고       
Joiner가 클러스터와 노드가 동기화 될때까지 순서대로 복제한다.         

### GCache(IST의 전송되지 않은 데이터 식별하기)   
갈레라 클러스터는 `GCache` 라는 자체 메모리를 사용한다.            
`GCache`에 write 한 데이터를 저장하고, 이를 비교하여 전송 누락된 데이터를 찾는다.       
  
GCache는 주로 메모리나, memory-mapped file로 물리적 디스크에 저장되며 디폴트 사이즈는 128M이다.   
이 범위를 넘어선 쓰기를 해야할 경우 IST 방식 대신 아래의 SST 방식으로 복제힌다.     
   
갈레라 클러스터는 GCache 라는 특수 캐시에 쓰기 데이터를 저장한다.            
GCache 는 쓰기 데이터에 대한 메모리 할당자로 주요 목적은 RAM 의 쓰기 데이터 메모리를 최소화하는 것이다.         

#### GCACHE 스토리지

* **Permanent In-Memory Store**.    
    * 쓰기 데이터는 운영 체제의 기본 메모리 할당자를 사용하여 할당한다.   
    * 여분의 RAM 이 있는 시스템에서 유용하다.    
    * 단, 해당 스토어(인메모리)는 엄격한 크기 제한이 있다.
    * 기본적으로 비활성화되어 있다.
      
* **Permanent Ring-Buffer File**    
    * 쓰기 데이터는 캐시 초기화 동안 디스크에 미리 할당한다.    
    * 기본 쓰기 데이터 저장소로 사용된다.  
    * 기본적으로 크기는 128Mb 이다. 
    
* **On-Demand Page Store**     
    * 쓰기 데이터는 필요에 따라 런타임 동안 메모리 매핑된 페이지 파일에 할당한다.    
    * 기본적으로 크기는 128Mb이지만 더 큰 쓰기 데이터를 저장해야 하는 경우 더 커질 수 있다. 
    * 페이지 저장소의 크기는 사용 가능한 디스크 공간에 의해 제한된다. 
    * 기본적으로 Galera Cluster는 사용하지 않을 때 
      페이지 파일을 삭제하지만 유지할 페이지 파일의 총 크기에 제한을 설정할 수 있다.
    * 다른 모든 저장소가 비활성화되면 디스크에 하나 이상의 페이지 파일이 남아 있다.
  
Galera Cluster는 위의 순서로 쓰기 데이터를 저장하려고 시도한다.       
1. 즉, 먼저 영구적인 메모리 내 저장소를 사용하려고 시도한다.       
2. 쓰기 데이터를 위한 공간이 충분하지 않으면 영구 링 버퍼 파일에 저장을 시도한다.      
3. 쓰기 데이터가 사용 가능한 디스크 공간보다 크지 않는 한 페이지 저장소는 항상 성공한다.  
        
기본적으로 쓰기 데이터 캐시는 프로세스의 작업 디렉토리에 파일한다.       
`gcache.dir` 매개변수 를 사용하여 쓰기 세트 캐싱을 위한 전용 위치를 지정할 수 있다.    

## 상태 스냅샷 전송(SST)
   
SST(상태 스냅샷 전송)에서 클러스터는 한 노드에서 다른 노드로 **전체 데이터 복사본을 전송하여 노드를 프로비저닝한다.**             
새 노드가 클러스터에 합류하면 새 노드는 상**태 스냅샷 전송을 시작하여 이미 클러스터의 일부로 존재하는 노드와 데이터를 동기화한다.**        
  
Galera Cluster에서 `논리 접근 방식`/`물리 접근 방식`을 통해 다른 데이터베이스로 상태를 전송할 수 있다.    
          
**논리 :**             
* mysqldump 를 사용한다.     
* 수신받을 서버를 완전히 초기화하고 **전송 전에 연결을 수락할 준비가 되어 있어야 한다.**          
* 블락킹 메서드이다.    
* 전송 기간 동안 도너 노드가 읽기 전용이 된다.      
* 상태 스냅샷 전송은 도너 노드에 FLUSH TABLES WITH READ LOCK 명령을 적용한다.   
* 그러나, mysqldump는 상태 스냅샷 전송을 위한 가장 느린 방법이므로 로드된 클러스터에서 문제가 될 수 있다.   

**물리 :**   
* rsync, rsync_wan, xtrabackup 및 기타 방법을 사용하고 데이터 파일을 서버에서 서버로 직접 복사한다.      
* 전송 후 수신 서버를 초기화해야 한다.       
* mysqldump보다 빠르지만 특정 제한 사항이 있다.    
    * 서버 시작 시에만 사용할 수 있다.   
    * 수신 서버는 기증자와 매우 유사한 구성이 필요하다   
    * (예: 두 서버 모두 동일한 innodb_file_per_table 값을 사용해야 함)    
* xtrabackup과 같은 방법 중 일부는 기증자를 비차단할 수 있다.    
* 스크립트 가능한 SST 인터페이스를 통해 지원된다.   

상태 스냅샷 전송에 사용할 수 있는 특정 방법에 대한 자세한 내용은 상태 스냅샷 전송을 참조하자.        
노드가 확인 파일에서 사용하는 State Snapshot Transfer 방법에 대해서 설정할 수 있다.        
    
```
wsrep_sst_method=rsync_wan
```
