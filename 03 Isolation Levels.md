# 03 Isolation Levels
     
데이터베이스 시스템에서 동시 트랜잭션은 서로 `격리`되어 처리된다.          
즉, **격리 수준**은 트랜잭션이 서로 영향을 미칠 수 있는 방법을 결정한다.     

## Galera 클러스터의 노드 내 및 노드 간 격리
         
갈레라 클러스터에서의 ISOLATION LEVEL은        
한 트랜잭션이 단일 노드에서만 행해지는지, 클러스터 노드간인지 구분해야한다.            
   
### 단일 노드 
단일 노드는 `MySQL/InnoDB`에서 지원하는 범위 내에서 모든 격리 수준을 제공할 수 있다.    

* READ-UNCOMMITTED
* READ-COMMITTED
* REAPEATABLE-READ
* SERIALIZABLE 

### 클러스터 노드 
   
'클러스터 노드' 격리 수준은 복제 프로토콜(동기식/비동기식)의 영향을 받으므로               
서로 다른 노드에서 실행된 트랜잭션은 동일한 노드에서 실행된 트랜잭션과 동일하게 분리되지 않을 수 있다.     
   
* READ-UNCOMMITTED  
* READ-COMMITTED   
* REPEATABLE-READ  

다른 노드에서 발행된 트랜잭션의 경우 `격리`는 **first committer wins 룰**에 의해 강화된다.     
**first committer wins 룰은**, 이러한 수준에 고유한 "업데이트 손실 이상"을 제거 하는 반면  
동일한 노드에서 발행된 트랜잭션의 경우 이 규칙이 유지되지 않습니다(원래 MySQL/InnoDB 동작에 따라).
  
이것은 트랜잭션 기원에 따라 다른 결과를 만들지만     
(같은 노드에서 발행된 트랜잭션은 성공할 수 있지만, 다른 노드에서 발행된 동일한 트랜잭션은 실패할 수 있음)      
어느 경우에도 독립 실행형 MySQL/InnoDB의 분리 수준보다 약하지 않다.  
        
**SERIALIZABLE 격리 수준**은 동일한 노드에서 발행된 트랜잭션 간에만 적용되므로 피해야 한다.     
노드 간의 데이터 일관성은 클라이언트가 선택한 격리 수준에 관계없이 항상 보장된다.       
그러나 지정된 구성에서 지원되지 않는 격리 수준에 의존하는 경우 클라이언트 논리가 중단될 수 있다.   

## 더 자세한 이야기

Galera Cluster는 클러스터 노드에서 실행되는 트랜잭션 간에 SNAPSHOT ISOLATION 을 제공한다.      

<img width="1172" alt="image" src="https://user-images.githubusercontent.com/50267433/189642732-26348de0-fdeb-4067-a186-985edb03b925.png">

**SNAPSHOT ISOLATION**.      
sql 92 에서 정의한 4가지 Isolation Level 외에       
위 표준 레벨에서 부족한 점을 개선하고자 주장되는 Isolation Level     
      
단일 노드에서는 X락(쓰기)을 걸기 쉽지만       
멀티 마스터를 지원하는 갈레라 클러스터에서는 각각의 DB 서버마다 쓰기가 가능하므로 락이 쉽지 않다.       
(동기화 후, 동일 행에 대해서 쓰기락이 다른 DB서버에 각각 동시에 발생한다면? -> 정합성이 깨진다.)   
    
**first committer win** 전략을 사용한다.           
write 한 작업들을 바로 커밋을 진행하지 않고 스냅샷에 저장한다.           
    
DB 데이터와 비교했을 때, 값에 따라 아래와 같이 동작한다.       
1. 쓰기가 이미 이루어졌을 경우(다른 노드에서 쓰기함) 스냅샵 데이터를 날린다.     
2. 쓰기가 이루어지지 않았을 경우 커밋을 통해 쓰기 작업을 진행한다.       

